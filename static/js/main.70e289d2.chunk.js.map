{"version":3,"sources":["errorHandleFunctions.js","index.js"],"names":["isDevelopment","process","isBrowser","window","toString","call","isNodeJS","global","stringifyAll","data","JSON","stringify","_key","val","Error","Object","getOwnPropertyNames","reduce","acc","key","stack","test","e","logError","params","funcDesc","err","args","Array","isArray","map","el","parse","stringOfArgs","arg","idx","console","log","error","commonProps","functionDescription","arguments","date","Date","toUTCString","alert","info","localUrl","location","href","machineInfo","browserInfo","navigator","userAgent","language","osType","platform","__filename","cpuArch","arch","depVersions","versions","createFunc","onTry","onCatch","innerCatch","apply","this","constructor","name","a","createMethods","obj","shouldHandleProto","forEach","Function","prototype","initUncaughtErrorHandling","server","port","sockets","Set","onUncaughtError","eventOrError","preventDefault","reason","document","body","style","close","socket","destroy","exitCode","setTimeout","exit","unref","addEventListener","on","add","delete","listen","Counter","React","memo","useState","count","setCount","delay","setDelay","useMemo","handleOnChange","target","value","handleOnClick","createEffects","id","clearTimeout","useEffect","type","onChange","onClick","rootElement","getElementById","ReactDOM","render"],"mappings":"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","file":"static/js/main.70e289d2.chunk.js","sourcesContent":["export const isDevelopment = process && process.env && process.env.NODE_ENV ?\r\n    process.env.NODE_ENV === 'development' :\r\n    false\r\n\r\nexport const isBrowser = typeof window !== 'undefined'\r\n    && ({}).toString.call(window) === '[object Window]'\r\n\r\nexport const isNodeJS = typeof global !== \"undefined\" \r\n    && ({}).toString.call(global) === '[object global]'\r\n\r\nexport const stringifyAll = function (data) {\r\n    try {\r\n        const parser = function(_key, val) {\r\n            if (val instanceof Error) {\r\n                return Object.getOwnPropertyNames(val).reduce((acc, key) => {\r\n                    acc[key] = val[key]\r\n                    return acc\r\n                }, { stack: val.stack })\r\n            }\r\n\r\n            if (typeof val === 'function') {\r\n                if (/^\\s*async\\s+/g.test(val)) {\r\n                     return '[function Async]'\r\n                }\r\n\r\n                if (/^\\s*class\\s*\\w*/g.test(val)) {\r\n                    return '[function Class]'\r\n                }\r\n\r\n                if (/^\\s*function\\s*\\*/g.test(val)) {\r\n                    return '[function Generator]'\r\n                }\r\n\r\n                if (/^\\s*\\(.*\\)\\s+=>/g.test(val)) {\r\n                    return '[function Arrow]'\r\n                }\r\n\r\n                return '[function Function]'\r\n            }\r\n\r\n            return val\r\n        }\r\n\r\n        return JSON.stringify(data, parser)\r\n    } catch(e) {\r\n        return JSON.stringify('[object Cyclic]')\r\n    }\r\n}\r\n\r\nexport const logError = function (params) {\r\n    params = params === Object(params) ? params : {}\r\n\r\n    const funcDesc = typeof params.funcDesc === 'string' ?\r\n        params.funcDesc :\r\n        'Unknown function'\r\n    const err = params.err instanceof Error ?\r\n        params.err :\r\n        new Error('Unknown error')\r\n    const args = Array.isArray(params.args) ?\r\n        params.args.map(el => JSON.parse(stringifyAll(el))) :\r\n        ['[unknown]']\r\n\r\n    const stringOfArgs = args.reduce((acc, arg, idx) => {\r\n        return idx === 0 ? (acc + arg) : (acc + ` , ${arg}`)\r\n    }, '')\r\n\r\n    if (isDevelopment) {\r\n        console.log()\r\n        console.error(` Issue with: ${funcDesc}\\n Function arguments: ${stringOfArgs}\\n`, err)\r\n        console.log()\r\n    }\r\n\r\n    const commonProps = {\r\n        functionDescription: funcDesc,\r\n        arguments: args,\r\n        date: new Date().toUTCString(),\r\n        error: err\r\n    }\r\n\r\n    if (isBrowser) {\r\n        //TODO notify the user\r\n        alert(`Internal error with: ${funcDesc}`)\r\n\r\n        //TODO logging service in production\r\n        if (!isDevelopment) {\r\n            console.info(stringifyAll({\r\n                ...commonProps,\r\n                localUrl: window.location.href,\r\n                machineInfo: {\r\n                    browserInfo: window.navigator.userAgent,\r\n                    language: window.navigator.language,\r\n                    osType: window.navigator.platform\r\n                }\r\n            }))\r\n        }\r\n    }\r\n\r\n    if (isNodeJS && !isDevelopment) {\r\n        //TODO logging service in production\r\n        console.info(stringifyAll({\r\n            ...commonProps,\r\n            localUrl: __filename,\r\n            machineInfo: {\r\n                cpuArch: process.arch,\r\n                osType: process.platform,\r\n                depVersions: process.versions\r\n            }\r\n        }))\r\n    }\r\n}\r\n\r\nexport const createFunc = function(funcDesc, onTry, onCatch) {\r\n    if (typeof onTry !== 'function') {\r\n        logError({\r\n            funcDesc: 'Undefined function',\r\n            err: new Error(`Instead of function was given ${onTry}`)\r\n        })\r\n\r\n        return function() {}\r\n    }\r\n\r\n    const innerCatch = function({ err, args }) {\r\n        logError({ funcDesc, err, args })\r\n        \r\n        if (typeof onCatch === 'function') {\r\n            return createFunc('Catching errors', onCatch)\r\n                .apply(this, args)\r\n        }\r\n    }\r\n\r\n    if (onTry.constructor.name === 'AsyncFunction') {\r\n        return async function(...args) {\r\n            try {\r\n                return await onTry.apply(this, args)\r\n            } catch(err) {\r\n                return innerCatch.call(this, { err, args })\r\n            }\r\n        }\r\n    }\r\n\r\n    return function(...args) {\r\n        try {\r\n            return onTry.apply(this, args)\r\n        } catch(err) {\r\n            return innerCatch.call(this, { err, args })\r\n        }\r\n    }\r\n}\r\n\r\nexport const createMethods = createFunc(\r\n    'Error handling methods',\r\n    (obj, shouldHandleProto = false) => {\r\n        Object.getOwnPropertyNames(obj).forEach(key => {\r\n            if (key !== 'constructor' && obj[key] instanceof Function) {\r\n                obj[key] = createFunc.call(obj,\r\n                    `Executing method ${key}`,\r\n                    obj[key],\r\n                    obj.onCatch\r\n                )\r\n            }\r\n        })\r\n        \r\n        if(shouldHandleProto) {\r\n            createMethods(obj.prototype, false)\r\n        }\r\n\r\n        return obj\r\n    },\r\n    obj => obj\r\n)\r\n\r\nexport const getWrapApp = app => createFunc(\r\n    'Wrapping the server',\r\n    (method, path, onTry) => {\r\n        if (\r\n            typeof method !== 'string' ||\r\n            typeof path !== 'string' ||\r\n            typeof onTry !== 'function' ||\r\n            app !== Object(app)\r\n        ) {\r\n            return\r\n        }\r\n\r\n        app[method](path, createFunc(\r\n            `app.${method}('${path}')`,\r\n            onTry,\r\n            (req, res, next) => {\r\n                if (!res.headersSent) {\r\n                    res.status(500).json({ message: 'Server error' })\r\n                }\r\n            }\r\n        ))\r\n    }\r\n)\r\n\r\nexport const initUncaughtErrorHandling = createFunc(\r\n    'Initializing uncaught errors handling',\r\n    (args = {}) => {\r\n        const server = args.server\r\n        const port = args.port || 8080\r\n        const sockets = args.sockets || new Set()\r\n\r\n        const onUncaughtError = function(eventOrError) {\r\n            const funcDesc = 'The app crashed, please restart!'\r\n\r\n            if (isBrowser) {\r\n                eventOrError.preventDefault()\r\n\r\n                logError({ funcDesc, err: eventOrError.error || eventOrError.reason })\r\n\r\n                //TODO in prod prevent user from interacting with the page\r\n                if (!isDevelopment) {\r\n                    window.document.body.style['pointer-events'] = 'none'\r\n                }\r\n            }\r\n\r\n            if (isNodeJS) {\r\n                if (server === Object(server) && server.close) {\r\n                    server.close()\r\n                }\r\n                if (sockets instanceof Set) {\r\n                    sockets.forEach(socket => { socket.destroy() })\r\n                }\r\n\r\n                let exitCode = 0\r\n\r\n                if (eventOrError instanceof Error) {\r\n                    exitCode = 1\r\n                    logError({ funcDesc, err: eventOrError })\r\n                }\r\n\r\n                setTimeout(() => { process.exit(exitCode) }, 1000).unref()\r\n            }\r\n        }\r\n\r\n\r\n        if (isBrowser) {\r\n            window.addEventListener('error', onUncaughtError, true)\r\n            window.addEventListener('unhandledrejection', onUncaughtError, true)\r\n        }\r\n\r\n        if (isNodeJS) {\r\n            if (server === Object(server)) {\r\n                server.on('connection', socket => {\r\n                    sockets.add(socket);\r\n\r\n                    socket.on('close', () => { sockets.delete(socket) })\r\n                })\r\n\r\n                server.listen(port, err => {\r\n                    if (err) throw err\r\n                    console.log(`Server listening on ${port}`)\r\n                })\r\n            }\r\n\r\n            process.on('uncaughtException', onUncaughtError)\r\n            process.on('unhandledRejection', onUncaughtError)\r\n            process.on('SIGTERM', onUncaughtError)\r\n            process.on('SIGINT', onUncaughtError)\r\n        }\r\n    }\r\n)\r\n\r\n/*\r\n// *** EXAMPLES ***\r\nif (isBrowser) {\r\n    initUncaughtErrorHandling()\r\n}\r\n\r\nif (isNodeJS) {\r\n    // Use `nodemon` for restarting on change\r\n    // Usef `forever` for restarting on crash\r\n    const http = require('http')\r\n    const express = require('express')\r\n    const app = express()\r\n    const wrapApp = getWrapApp(app)\r\n\r\n    wrapApp('use', '/', express.urlencoded({ extended: true }))\r\n    wrapApp('use', '/', express.json())\r\n    wrapApp('use', '/', (req, res, next) => {\r\n        res.set('Access-Control-Allow-Origin', '*')\r\n        res.set(\r\n            'Access-Control-Allow-Headers',\r\n            'Origin, X-Requested-With, Content-Type, Accept'\r\n        )\r\n        next()\r\n    })\r\n\r\n    wrapApp('get', '/', (req, res, next) => {\r\n        res.send('Hello World!')\r\n\r\n        throw new Error('whoops')\r\n    })\r\n\r\n    wrapApp('get', '/err', async (req, res, next) => {\r\n        await new Promise(resolve => setTimeout(resolve, 1000))\r\n\r\n        throw new Error('Async whoops')\r\n    })\r\n\r\n    app.get('/uncaught', async (req, res, next) => {\r\n        throw new Error('Is uncaught error')\r\n    })\r\n\r\n    wrapApp('all', '*', (req, res, next) => {\r\n        res.status(404).json({ message: 'Page not found' })\r\n    })\r\n\r\n    initUncaughtErrorHandling({ server: http.createServer(app) })\r\n}\r\n\r\nexport const printNum = createFunc(\r\n    'Printing a number',\r\n    num => {\r\n        blabla\r\n        return num\r\n    },\r\n    num => {\r\n        console.log(`Ran inside catch - the argument was ${num}`)\r\n        return 0\r\n    }\r\n)\r\n\r\nexport const measureFib = createFunc(\r\n    'Measuring time for fibonacci number',\r\n    num => {\r\n        const fib = n => {\r\n            if (n < 0 || Math.trunc(n) !== n)\r\n                throw new Error('num had to be positive integer')\r\n\r\n            return n <= 1 ? n : fib(n-1) + fib(n-2)\r\n        }\r\n\r\n        const startTime = Date.now()\t\r\n    \r\n        try {\r\n            return fib(num)\r\n        } finally {\r\n            console.log(`execution time ${Date.now() - startTime}ms`)\r\n        }\r\n    },\r\n    () => 'Incorrect fibonacchi calculation'\r\n)\r\n\r\nexport const delayReturn = createFunc(\r\n    'Delaying async function',\r\n    async (ms) => {\r\n        await new Promise(resolve => setTimeout(resolve, ms))\r\n        \r\n        if (typeof ms === 'number')\r\n            return 'Proper result'\r\n        else\r\n            throw new Error('Async error from promise')\r\n    },\r\n    () => 'Default result'\r\n)\r\n\r\nexport const undefinedFunc = createFunc()\r\n\r\nconsole.log('undefinedFunc(31)', undefinedFunc(31))\r\nconsole.log('printNum(9)', printNum(9))\r\ndelayReturn(10).then(val => console.log('delayReturn(10) ' + val))\r\nconsole.log('measureFib(35)', measureFib(35))\r\nconsole.log(\r\n    'measureFib({ a: [ 2, 5, { b: { c: 123 } } ] }, -32.55)',\r\n    measureFib({ a: [ 2, 5, { b: { c: 123 } } ] }, -32.55)\r\n)\r\nconsole.log('measureFib(-12)', measureFib(-12))\r\nconsole.log('\\nThe program continues...')\r\ndelayReturn('invalid ms').then(val => console.log('delayReturn(\"invalid ms\")', val))\r\n//new Promise(() => { uncaughtAsyncFunc() })\r\n//setTimeout(() => { uncaughtSyncFunc() }, 500)\r\n*/\r\n","import React, { useState, useEffect, useMemo } from 'react'\nimport ReactDOM from 'react-dom'\nimport './index.css';\nimport { createFunc, createMethods, initUncaughtErrorHandling } from './errorHandleFunctions'\n\ninitUncaughtErrorHandling()\n\nconst Counter = React.memo(createFunc(\n    'Showing the counter',\n    () => {\n        const [count, setCount] = useState(0)\n        const [delay, setDelay] = useState(1000)\n\n        const { handleOnChange, handleOnClick } = useMemo(() => createMethods({\n            handleOnChange: (e) => {\n                setDelay(e.target.value)\n            },\n            handleOnClick: () => {\n                setCount(0)\n            }\n        }), [setCount, setDelay])\n\n        const createEffects = useMemo(() => createFunc(\n            'Using side effects',\n            () => {\n                const id = setTimeout(createFunc(\n                    'Ticking the timer',\n                    () => { setCount(count + 1) }\n                ), delay)\n\n                return () => clearTimeout(id)\n            }\n        ), [count, delay])\n\n        // Set up the interval.\n        useEffect(() => createEffects(), [createEffects])\n\n        return (\n            <>\n                <h1>Counter: {count}</h1>\n                <label>\n                    Delay:\n                    <input type=\"text\" value={delay} onChange={handleOnChange} />\n                </label>\n                <button onClick={handleOnClick}>Reset</button>\n            </>\n        )\n    },\n    () => <h1>Error with the counter</h1>\n))\n\nconst rootElement = document.getElementById('root')\nReactDOM.render(<Counter />, rootElement)\n"],"sourceRoot":""}